# API Endpoint Implementation Plan: List Stashes

## 1. Endpoint Overview

This document outlines the implementation plan for the `GET /api/stashes` endpoint. The purpose of this endpoint is to retrieve a paginated and sortable list of active stashes for the authenticated user. It supports sorting by name and creation date, and provides pagination controls.

## 2. Request Details

- **HTTP Method**: `GET`
- **URL Structure**: `/api/stashes`
- **Parameters**:
  - **Optional Query Parameters**:
    - `page`: `number` - The page number to retrieve. Defaults to `1`.
    - `limit`: `number` - The number of items per page. Defaults to `20`, with a maximum of `100`.
    - `sort`: `string` - The field to sort by. Allowed values: `created_at`, `name`. Defaults to `created_at`.
    - `order`: `string` - The sort order. Allowed values: `asc`, `desc`. Defaults to `desc`.
- **Request Body**: None.

## 3. Used Types

To ensure type safety and consistent data structures, the following types will be used or created in `src/types.ts`:

```typescript
// src/types.ts

import { z } from "zod";

// ... existing types

/**
 * Zod schema for validating the query parameters of the List Stashes endpoint.
 */
export const ListStashesQuerySchema = z.object({
  page: z.coerce.number().int().min(1).default(1),
  limit: z.coerce.number().int().min(1).max(100).default(20),
  sort: z.enum(['created_at', 'name']).default('created_at'),
  order: z.enum(['asc', 'desc']).default('desc'),
});

/**
 * Type derived from the Zod schema for use in the service layer.
 */
export type ListStashesQuery = z.infer<typeof ListStashesQuerySchema>;

/**
 * DTO for the items in the stash list response.
 * Reuses the existing StashDTO.
 */
export type StashListItemDTO = StashDTO;

/**
 * Standardized paginated API response structure.
 */
export interface ApiPaginatedResponse<T> {
  data: T[];
  pagination: {
    page: number;
    limit: number;
    total: number;
  };
}
```

## 4. Response Details

- **Success (200 OK)**: A JSON response containing the list of stashes and pagination metadata.

  ```json
  {
    "data": [
      {
        "id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
        "name": "Vacation Fund",
        "current_balance": "1500.00",
        "created_at": "2023-10-21T10:00:00Z",
        "updated_at": "2023-10-21T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 1
    }
  }
  ```

- **Error (4xx/5xx)**: A JSON response detailing the error.

  ```json
  {
    "error": "Error Type",
    "message": "A descriptive error message."
  }
  ```

## 5. Data Flow

1.  A `GET` request is made to `/api/stashes`.
2.  Astro middleware verifies the user's authentication status via Supabase JWT.
3.  The API route handler at `src/pages/api/stashes/index.ts` receives the request.
4.  The handler parses and validates the query parameters (`page`, `limit`, `sort`, `order`) using the `ListStashesQuerySchema`.
5.  If validation fails, a `400 Bad Request` is returned.
6.  If the user is not authenticated (i.e., `Astro.locals.user` is null), a `401 Unauthorized` is returned.
7.  The handler calls the `listStashes` method in `src/lib/services/stash.service.ts`, passing the `SupabaseClient` instance, `userId`, and the validated query parameters.
8.  The `stash.service` constructs a Supabase query to fetch stashes from the `stashes` table.
    - It filters by `user_id` to ensure data isolation.
    - It filters for active records (`deleted_at IS NULL`).
    - It applies sorting and pagination based on the query parameters.
9.  The service executes the query to get both the data and the total count for pagination.
10. The service returns the data and pagination details to the handler.
11. The handler formats the response according to the `ApiPaginatedResponse<StashListItemDTO>` structure and sends it back to the client with a `200 OK` status.

## 6. Security Considerations

- **Authentication**: Access is restricted to authenticated users. The Astro middleware must enforce this by checking for a valid session. The handler will explicitly check for `Astro.locals.user`.
- **Authorization**: The database query is strictly filtered by the `user_id` from the authenticated session to prevent users from accessing each other's data.
- **Input Validation**: All query parameters are strictly validated using Zod to prevent invalid values and potential for injection attacks (though Supabase client mitigates SQLi).
- **Denial of Service**: The `limit` parameter is capped at `100` to prevent abuse and protect database performance.

## 7. Error Handling

- **400 Bad Request**: Returned if query parameter validation fails. The response body will include details from the Zod validation error.
- **401 Unauthorized**: Returned if the user is not authenticated.
- **500 Internal Server Error**: Returned for any unexpected server-side errors, such as a database query failure. The error will be logged to the console for debugging.

## 8. Performance

- **Database Indexing**: Ensure an index exists on `(user_id, deleted_at)` in the `stashes` table to optimize query performance.
- **Pagination**: Pagination is mandatory and enforced with a max limit to avoid fetching large datasets and ensure fast response times.

## 9. Implementation Steps

1.  **Update Types**: Add `ListStashesQuerySchema`, `ListStashesQuery`, and `ApiPaginatedResponse` to `src/types.ts`.
2.  **Create Service**: Create a new file `src/lib/services/stash.service.ts`.
3.  **Implement `listStashes` Method**: In the service file, implement the `listStashes` function to handle the database query logic as described in the Data Flow section.
4.  **Create API Route**: Create the API endpoint file at `src/pages/api/stashes/index.ts`.
5.  **Implement Route Handler**: In the route file, implement the `GET` handler. This includes:
    - Validating query parameters.
    - Checking for user authentication.
    - Calling the `stash.service.listStashes` method.
    - Formatting and returning the final response or error.
