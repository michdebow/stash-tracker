# API Endpoint Implementation Plan: Get Single Stash

## 1. Endpoint Overview
This document outlines the implementation plan for the `GET /api/stashes/{stashId}` endpoint. Its purpose is to retrieve detailed information for a specific stash belonging to the authenticated user. The endpoint can optionally include a list of the 50 most recent transactions associated with the stash.

## 2. Request Details
- **HTTP Method**: `GET`
- **URL Structure**: `/api/stashes/{stashId}`
- **Parameters**:
  - **Path**: 
    - `stashId` (string, UUID): **Required**. The unique identifier of the stash to retrieve.
  - **Query**:
    - `includeTransactions` (boolean): **Optional**. If `true`, the response will include an array of the 50 most recent transactions. Defaults to `false`.

## 3. Used Types
To ensure type safety and consistency, the following types from `src/types.ts` will be used or created:

- **`StashDTO`**: `Omit<Stash, "deleted_at" | "user_id">` (Existing)
- **`StashTransactionDTO`**: `Omit<StashTransaction, "deleted_at" | "user_id">` (Existing)
- **`StashDetailsDTO`** (New Type): This DTO will represent the final response payload.
  ```typescript
  // To be added to src/types.ts
  /**
   * DTO for a single stash with optional recent transactions.
   */
  export interface StashDetailsDTO extends StashDTO {
    transactions?: StashTransactionDTO[];
  }
  ```

## 4. Response Details

- **Success (200 OK)**: Returned when the stash is found for the authenticated user.
  ```json
  {
    "data": {
      "id": "uuid",
      "name": "string",
      "current_balance": "number",
      "created_at": "timestamp",
      "updated_at": "timestamp",
      "transactions": [
        {
          "id": "uuid",
          "transaction_type": "deposit",
          "amount": "number",
          "description": "string",
          "created_at": "timestamp"
        }
      ]
    }
  }
  ```
- **Error**: See Error Handling section for details on `400`, `401`, `404`, and `500` responses.

## 5. Data Flow
1. A `GET` request is made to `/api/stashes/{stashId}`.
2. Astro middleware verifies the user's authentication status. If the user is not authenticated, a `401 Unauthorized` is returned.
3. The API route handler validates the `stashId` path parameter (must be a UUID) and the `includeTransactions` query parameter (must be a boolean) using `zod`.
4. The handler calls the `stashService.getStashDetails(userId, stashId, includeTransactions)` method.
5. The `stashService` executes a database query to fetch the stash where `id` matches `stashId` and `user_id` matches the authenticated user's ID. It must also filter for `deleted_at IS NULL`.
6. If `includeTransactions` is `true`, the service performs a second query to fetch the 50 most recent transactions for the stash, ordered by `created_at` descending.
7. The service combines the stash and transaction data into a `StashDetailsDTO` object.
8. The API route handler receives the DTO from the service, wraps it in a `data` object, and returns it with a `200 OK` status.

## 6. Security Considerations
- **Authentication**: The endpoint must be protected and accessible only to authenticated users. This will be enforced by Astro middleware, which checks for a valid Supabase session and attaches the user object to `context.locals`.
- **Authorization**: All database queries for stashes and transactions **must** include a `WHERE` clause filtering by the authenticated `user_id` (`context.locals.user.id`). This prevents a user from accessing another user's data (IDOR).
- **Input Validation**: The `stashId` will be strictly validated as a UUID to prevent SQL injection or other malformed input attacks. The `includeTransactions` parameter will be validated as a boolean.

## 7. Error Handling
- **400 Bad Request**: Returned if `stashId` is not a valid UUID format. The response body will contain a validation error message.
- **401 Unauthorized**: Returned by the middleware if the request lacks a valid authentication token.
- **404 Not Found**: Returned if no stash is found with the given `stashId` for the authenticated user, or if the stash has been soft-deleted.
- **500 Internal Server Error**: Returned for any unexpected server-side issues, such as a database connection failure. Errors will be logged for debugging.

## 8. Performance
- **Database Indexing**: Ensure that the `stashes(user_id, id)` and `stash_transactions(stash_id, created_at)` columns are indexed to ensure fast lookups.
- **Query Limiting**: The transaction query is naturally limited to 50 records, preventing large data transfers.
- **Conditional Query**: The transaction query is only executed when `includeTransactions` is `true`, avoiding unnecessary database load.

## 9. Implementation Steps
1.  **Create API Route File**: Create the file `src/pages/api/stashes/[stashId].ts`.
2.  **Update Types**: Add the new `StashDetailsDTO` interface to `src/types.ts`.
3.  **Create/Update Service**: Create `src/lib/services/stash.service.ts` if it does not exist.
4.  **Implement Service Method**: Add the `getStashDetails` method to `stash.service.ts`. This method will contain the core database logic for fetching the stash and its optional transactions.
5.  **Implement Route Handler**: In `[stashId].ts`, implement the `GET` handler:
    a. Retrieve the user session from `context.locals.user`.
    b. Define a `zod` schema to validate the `stashId` (as a UUID) and `includeTransactions` (as a boolean).
    c. Parse and validate the request parameters.
    d. Call `stashService.getStashDetails` with the validated parameters.
    e. Implement a `try...catch` block to handle potential errors from the service and return the appropriate HTTP status codes (`404`, `500`).
    f. On success, return a `200 OK` response with the fetched data.
