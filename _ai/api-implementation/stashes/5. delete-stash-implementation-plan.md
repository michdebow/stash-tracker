# API Endpoint Implementation Plan: Soft Delete Stash

## 1. Endpoint Overview
This document outlines the implementation plan for the `DELETE /api/stashes/{stashId}` endpoint. The endpoint's purpose is to soft-delete a specific stash by updating its `deleted_at` timestamp in the database. This action is restricted to the authenticated owner of the stash.

## 2. Request Details
- **HTTP Method**: `DELETE`
- **URL Structure**: `/api/stashes/{stashId}`
- **Parameters**:
  - **Path**: 
    - `stashId` (required): The UUID of the stash to be deleted.
- **Request Body**: None.

## 3. Used Types
- **Path Parameter Schema** (for Zod validation in the API route):
  ```typescript
  import { z } from 'zod';

  export const StashIdPathParamsSchema = z.object({
    stashId: z.string().uuid({ message: 'Invalid stash ID format' }),
  });
  ```
- **Command Model** (to be added to `src/types.ts`):
  ```typescript
  export interface DeleteStashCommand {
    stashId: string;
    userId: string;
  }
  ```

## 4. Response Details
- **Success**:
  - **Status Code**: `204 No Content`
  - **Body**: None. An empty response is sent upon successful deletion.
- **Error**:
  - **Status Codes**: `400 Bad Request`, `401 Unauthorized`, `404 Not Found`, `409 Conflict`, `500 Internal Server Error`.
  - **Body**: 
    ```json
    {
      "message": "Error description"
    }
    ```

## 5. Data Flow
1. A `DELETE` request is sent to `/api/stashes/{stashId}`.
2. The Astro middleware verifies the user's authentication token. If invalid, it returns `401 Unauthorized`.
3. The API route handler at `src/pages/api/stashes/[stashId].ts` parses and validates the `stashId` from the URL using the `StashIdPathParamsSchema`.
4. If validation fails, a `400 Bad Request` response is returned.
5. The handler constructs a `DeleteStashCommand` object containing the `stashId` and the authenticated `userId` from `context.locals.user.id`.
6. The handler calls the `deleteStash` method in the `stashService`, passing the command object.
7. The `stashService` attempts to update the `stashes` table, setting the `deleted_at` field for the record where `id` matches `stashId` and `user_id` matches `userId`.
8. If the update affects zero rows (meaning no matching stash was found for that user), the service returns a result indicating failure, and the handler sends a `404 Not Found` response.
9. If the database update violates a constraint (e.g., a trigger preventing deletion), the service catches the specific database error and the handler returns a `409 Conflict`.
10. On successful update, the handler returns a `204 No Content` response.

## 6. Security Considerations
- **Authentication**: All requests to this endpoint must be authenticated. This will be enforced by the existing Astro middleware that checks for a valid Supabase session.
- **Authorization**: The core of the authorization logic resides in the database query within `stashService`. The `UPDATE` statement will strictly filter by both `stashId` and the `userId` from the authenticated session. This prevents a user from deleting another user's stash.
- **Input Validation**: The `stashId` path parameter will be strictly validated as a UUID using Zod to prevent invalid data from reaching the service layer and database.

## 7. Error Handling
- **400 Bad Request**: Returned if `stashId` is not a valid UUID.
- **401 Unauthorized**: Returned by middleware if the user is not authenticated.
- **404 Not Found**: Returned if the `stashId` does not correspond to a stash owned by the authenticated user.
- **409 Conflict**: Returned if a database trigger or constraint prevents the deletion.
- **500 Internal Server Error**: Returned for any other unexpected exceptions. Errors will be logged to the console for debugging.

## 8. Performance Considerations
- The operation involves a single `UPDATE` query on an indexed primary key (`id`) and a foreign key (`user_id`), which should be highly performant.
- No significant performance bottlenecks are anticipated for this endpoint.

## 9. Implementation Steps
1. **Update Types**: Add the `DeleteStashCommand` interface to `src/types.ts`.
2. **Create Service Logic**: 
   - If it doesn't exist, create `src/lib/services/stash.service.ts`.
   - Implement the `deleteStash(command: DeleteStashCommand)` method. This method will contain the Supabase query to update the `deleted_at` field for the specified stash, ensuring the `user_id` matches.
   - The method should handle database errors and return a structured result indicating success or failure (e.g., `{ success: true }` or `{ success: false, error: 'NotFound' }`).
3. **Create API Endpoint**:
   - Create the file `src/pages/api/stashes/[stashId].ts`.
   - Add `export const prerender = false;`.
   - Implement the `DELETE` handler function (`export async function DELETE({ params, locals }: APIContext)`).
   - Inside the handler, use Zod to validate `params` against `StashIdPathParamsSchema`.
   - Retrieve the authenticated user from `locals.user`.
   - Call the `stashService.deleteStash` method.
   - Return the appropriate `Response` object with the correct status code based on the service's result.
