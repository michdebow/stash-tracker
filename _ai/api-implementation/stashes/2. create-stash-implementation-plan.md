# API Endpoint Implementation Plan: Create Stash

## 1. Endpoint Overview
This document outlines the implementation plan for the `POST /api/stashes` endpoint. This endpoint allows an authenticated user to create a new stash by providing a name. A successful request will add a new record to the `stashes` table and return the newly created stash object.

## 2. Request Details
- **HTTP Method:** `POST`
- **URL Structure:** `/api/stashes`
- **Headers:**
  - `Content-Type: application/json`
  - `Authorization: Bearer <session-token>` (Handled by middleware)
- **Request Body:**
  ```json
  {
    "name": "string"
  }
  ```

## 3. Used Types
- **`CreateStashDto` (Zod Schema in `src/pages/api/stashes/index.ts`):** To validate the incoming request body.
  ```typescript
  import { z } from 'zod';

  export const CreateStashDto = z.object({
    name: z.string().min(1, 'Name is required').max(100, 'Name must be 100 characters or fewer'),
  });
  ```
- **`Stash` (Entity in `src/types.ts`):** Represents the stash record in the database.
  ```typescript
  export interface Stash {
    id: string;
    user_id: string;
    name: string;
    current_balance: number;
    created_at: string;
    updated_at: string;
    deleted_at: string | null;
  }
  ```
- **`StashDto` (Response DTO in `src/types.ts`):** The data structure for the API response.
  ```typescript
  export interface StashDto {
    id: string;
    name: string;
    current_balance: string;
    created_at: string;
  }
  ```

## 4. Response Details
- **Success (`201 Created`):** Returned when the stash is created successfully.
  ```json
  {
    "data": {
      "id": "uuid",
      "name": "string",
      "current_balance": "0.00",
      "created_at": "timestamp"
    }
  }
  ```
- **Error (See Section 6 for details):** `400`, `401`, `409`, `500`.

## 5. Data Flow
1.  A `POST` request is sent to `/api/stashes` with the stash name in the body.
2.  The Astro middleware intercepts the request, verifies the user's session, and attaches `context.locals.user` and `context.locals.supabase`.
3.  The API route handler (`src/pages/api/stashes/index.ts`) parses and validates the request body using the `CreateStashDto` Zod schema.
4.  The handler calls the `StashService.createStash()` method, passing the validated `name` and the `user.id` from `context.locals`.
5.  The `StashService` checks if a stash with the same name already exists for that user to prevent duplicates.
6.  If no duplicate exists, the service uses the Supabase client to insert a new record into the `stashes` table with the provided `user_id` and `name`.
7.  The database returns the newly created stash record.
8.  The service formats the record into a `StashDto` (e.g., converting `current_balance` to a formatted string) and returns it to the handler.
9.  The handler constructs the final JSON response and sends it back to the client with a `201 Created` status.

## 6. Security Considerations
- **Authentication:** Access is restricted to authenticated users. The Astro middleware must reject any request without a valid session, returning a `401 Unauthorized`.
- **Authorization:** Users can only create stashes for themselves. The `user_id` for the new record is taken directly from the session, not from the request body, preventing users from creating stashes on behalf of others.
- **Data Validation:** All incoming data is strictly validated using Zod to prevent invalid or malicious data from reaching the database. This includes checking for type, length, and presence.
- **Duplicate Data:** The service layer explicitly checks for existing stashes with the same name for the user to enforce the unique constraint and provide a clear `409 Conflict` error.

## 7. Error Handling
- **`400 Bad Request`:** Returned if the request body fails validation (e.g., `name` is missing, empty, or too long). The response body should contain a descriptive error message from Zod.
- **`401 Unauthorized`:** Returned by the middleware if the user is not authenticated.
- **`409 Conflict`:** Returned if a stash with the same name already exists for the authenticated user.
- **`500 Internal Server Error`:** Returned for any unexpected exceptions, such as a database connection failure. The error will be logged for debugging.

## 8. Performance Considerations
- The primary database operation is an `INSERT`. A database index on `(user_id, name)` is critical for quickly checking for duplicates and will be enforced by the `UNIQUE` constraint.
- The query to check for duplicates should be highly efficient due to this index.
- The overall performance is expected to be high, as the operation is simple and properly indexed.

## 9. Implementation Steps
1.  **Update Types:** Add the `Stash` and `StashDto` interfaces to `src/types.ts` if they do not already exist.
2.  **Create Service File:** Create a new file `src/lib/services/stash.service.ts`.
3.  **Implement `StashService`:**
    -   Define a `StashService` class.
    -   Create a `createStash(supabase: SupabaseClient, userId: string, data: { name: string }): Promise<Stash>` method.
    -   Inside `createStash`, first query the `stashes` table to check for a record where `user_id` and `name` match.
    -   If a duplicate is found, throw a custom error (e.g., `Error('DUPLICATE_STASH')`).
    -   If no duplicate, use `supabase.from('stashes').insert(...).select().single()` to create the new stash.
    -   Handle potential database errors from the insert operation.
    -   Return the newly created stash record.
4.  **Create API Endpoint:**
    -   Create the file `src/pages/api/stashes/index.ts`.
    -   Export `export const prerender = false`.
    -   Define the `POST` handler function: `export async function POST(context: APIContext)`.
5.  **Implement API Handler Logic:**
    -   Check for `context.locals.user`. If not present, return a `401` response.
    -   Parse the JSON body from the request.
    -   Validate the body using `CreateStashDto.safeParse()`.
    -   If validation fails, return a `400` response with the validation errors.
    -   Instantiate `StashService` and call `createStash()` within a `try...catch` block.
    -   If the service throws a duplicate error, return a `409` response.
    -   If any other error occurs, return a `500` response.
    -   On success, map the returned `Stash` entity to a `StashDto` (formatting `current_balance` as a string `"0.00"`).
    -   Return a `201 Created` JSON response with the `StashDto`.
